<!DOCTYPE html>
<html>
  <head>
    <title>Kyiv Pollution Heatmap</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <!-- Leaflet.heat JavaScript -->
    <script src="https://leaflet.github.io/Leaflet.heat/dist/leaflet-heat.js"></script>
    <!-- Papa Parse JavaScript for CSV parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <style>
      #map {
        height: 500px;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <input type="file" id="upload" accept=".csv" />

    <script>
      // Initialize the map and set its view to Kyiv
      var map = L.map("map").setView([50.45, 30.523], 12);

      // Load and display tile layer (for city layout)
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "&copy; OpenStreetMap contributors",
      }).addTo(map);

      // Function to process CSV and update heatmap
      function processCSVData(results) {
        // Limit the data to the first 100 rows
        var data = results.data
          .slice(0, results.data.length - 10)
          .map(function (row) {
            return [
              parseFloat(row.Latitude),
              parseFloat(row.Longitude),
              parseFloat(row.CO / 5),
            ]; // normalize CO
          });

        console.log(data);

        // Create heatmap layer
        var heat = L.heatLayer(data, {
          radius: 25,
          blur: 15,
          maxZoom: 17,
        }).addTo(map);
      }

      // Handle file upload and CSV parsing
      document
        .getElementById("upload")
        .addEventListener("change", function (e) {
          var file = e.target.files[0];
          if (file) {
            Papa.parse(file, {
              header: true,
              dynamicTyping: true,
              complete: function (results) {
                processCSVData(results);
              },
            });
          }
        });
    </script>
  </body>
</html>
